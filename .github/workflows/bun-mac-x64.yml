name: bun-macOS-x64
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TEST_TAG: bun-test'

on:
  push:
    branches: [main, bun-actions]
    paths:
      - "src/**/*"
      - "test/**/*"
      - "build.zig"
      - "Makefile"
      - "Dockerfile"
  pull_request:
    branches: [main]
    paths:
      - "src/**/*"
      - "test/**/*"
      - "build.zig"
      - "Makefile"
      - "Dockerfile"
  workflow_dispatch:

jobs:
  macos-object-files:
    name: macOS Object
    runs-on: linux-amd64
    if: github.repository_owner == 'oven-sh'
    strategy:
      matrix:
        include:
          - cpu: haswell
            arch: x86_64
            tag: bun-obj-darwin-x64
    steps:
      - uses: actions/checkout@v3
      - name: Object files
        uses: oven-sh/bun/.github/actions/builds/macos/object-files@main
        env:
          cpu: ${{ matrix.cpu }}
          arch: ${{ matrix.aarch }}
          tag: ${{ matrix.tag }}
  macOS-cpp:
    name: macOS C++
    runs-on: ${{ matrix.runner }}
    if: github.repository_owner == 'oven-sh'
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - cpu: haswell
            arch: x86_64
            tag: bun-darwin-x64
            obj: bun-obj-darwin-x64
            runner: macos-11
            artifact: bun-obj-darwin-x64
            webkit_url: "https://github.com/oven-sh/WebKit/releases/download/latest/bun-webkit-macos-amd64-lto.tar.gz"
            dependencies: true
            compile_obj: false
          - cpu: haswell
            arch: x86_64
            tag: bun-darwin-x64
            obj: bun-obj-darwin-x64
            runner: macos-11
            artifact: bun-obj-darwin-x64
            webkit_url: "https://github.com/oven-sh/WebKit/releases/download/latest/bun-webkit-macos-amd64-lto.tar.gz"
            dependencies: false
            compile_obj: true
    steps:
      - uses: actions/checkout@v3
      - name: C++
        uses: oven-sh/bun/.github/actions/builds/macos/cpp@main
        env:
          cpu: ${{ matrix.cpu }}
          arch: ${{ matrix.aarch }}
          tag: ${{ matrix.tag }}
          obj: ${{ matrix.obj }}
          artifact: ${{ matrix.artifact }}
          webkit_url: ${{ matrix.webkit_url }}
          runner: ${{ matrix.runner }}
          dependencies: ${{ matrix.dependencies }}
          compile_obj: ${{ matrix.compile_obj }}

  macOS:
    name: macOS Link
    runs-on: ${{ matrix.runner }}
    if: github.repository_owner == 'oven-sh'
    needs: [macOS-cpp, macos-object-files]
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - cpu: haswell
            arch: x86_64
            tag: bun-darwin-x64
            obj: bun-obj-darwin-x64
            package: bun-darwin-x64
            runner: macos-11
            artifact: bun-obj-darwin-x64
            webkit_url: "https://github.com/oven-sh/WebKit/releases/download/latest/bun-webkit-macos-amd64-lto.tar.gz"
    steps:
      - uses: actions/checkout@v3
      - name: Link
        uses: oven-sh/bun/.github/actions/builds/macos/link@main
        env:
          cpu: ${{ matrix.cpu }}
          arch: ${{ matrix.aarch }}
          tag: ${{ matrix.tag }}
          obj: ${{ matrix.obj }}
          package: ${{ matrix.package }}
          artifact: ${{ matrix.artifact }}
          webkit_url: ${{ matrix.webkit_url }}
          runner: ${{ matrix.runner }}
